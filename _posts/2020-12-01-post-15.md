---
layout: post
title: 'Kakaotalk 데이터 가지고 놀기(2)'
description: '# 벌써_12월_아직_솔로'
date: 2020-12-01 20:16:41 +0900
categories: R Data
---
## 카카오톡 대화 내용 가져오기
[이전 포스팅][before]에서 서술한 것처럼 카카오 API에서는 대화 내용을 제공하지 않지만, 카카오톡 어플리케이션에서 대화내용을 추출할 수가 있습니다.

### 참조
[카카오톡 내보내기 텍스트, 사진, 동영상 내부저장소 저장하는 방법][export]

### 스마트폰과 컴퓨터에서의 차이점?
먼저, 스마트폰에서 가져온 대화내용입니다.
```
XX방 n명 카카오톡 대화
저장한 날짜 : 2020년 11월 30일 오후 8:39


2020년 11월 9일 오전 6:42
2020년 11월 9일 오전 6:42, 코딩노예님이 uowol님을 초대했습니다.
2020년 11월 9일 오전 6:42, 코딩노예 : .
2020년 11월 9일 오전 6:42, uowol : ㅎㅇㅎㅇ!
2020년 11월 9일 오전 6:42, uowol : @----->
```

다음은 컴퓨터 카카오톡에서 가져온 내용입니다.
```
XX방 님과 카카오톡 대화
저장한 날짜 : 2020-12-01 17:05:53

--------------- 2020년 11월 9일 월요일 ---------------
코딩노예님이 uowol님을 초대하였습니다.
[코딩노예] [오전 6:42] .
[uowol] [오전 6:42] ㅎㅇㅎㅇ!
[uowol] [오전 6:42] @----->
```

그럼 이 둘 중에 어떤 데이터를 사용할 것인지를 정해야 하는데, 

저는 이 참에 정규표현식도 복습할 겸 더 복잡해보이는 컴퓨터 버젼의 데이터를 선택했습니다.

---

## 투머치토커는 누구?
오늘은 데이터를 다루는데 뛰어난 성능을 보여주는 R언어를 사용하여 대화 내용을 분석해보려고 합니다.

### stringr 패키지 사용하기

먼저,

```R
# R > regularExpression.R

# install.packages('stringr') # 만약 설치가 안되어있다면 이것을 먼저 실행해야합니다.
library(stringr)
```

이번 프로그램은 문자열을 주로 다룰 것이기 때문에 관련된 라이브러리를 사용한다고 명시해줍니다.

정규표현식은 따로 명시하지 않아도 사용할 수 있습니다.

### 파일 읽어오기
저는 `C:\Users\uowol\Documents\dev`에 `R`이라는 폴더를 만들어 작업을 진행하고 있습니다.

![folder](/assets/imgs/post_15/folder.PNG "작업 폴더입니다")

이 때, R에서 자신이 작업하고 있는 폴더를 알고 싶다면 `getwd()`명령어를 통해 알 수 있고 `setwd()`명령어로 작업공간을 설정할 수 있습니다.

```R
getwd()
# > source("c:\\Users\\uowol\\Documents\\dev\\R\\regularExpression.R", encoding $
# [1] "C:/Users/uowol/Documents/dev"
```

계속해서 작업공간에 대한 이야기를 하고 있는 이유는

```R
# R > regularExpression.R
...
PATH = "R/KakaoTalkChats_오리방.txt"
...
```

파일을 이와 같이 **상대경로**로 읽어오기 위해서입니다.

제 작업공간이 `C:\Users\uowol\Documents\dev`이므로, 

`KakaoTalkChats_오리방.txt`파일에 접근하려면 `R`폴더에 들어가 `KakaoTalkChats_오리방.txt`에 접근하면 되기에 상대경로를 사용하면 쉽게 표현할 수 있었습니다.

```R
# R > regularExpression.R
...
data = readLines(PATH, encoding="UTF-8") # 한국어를표시하기 위한 utf-8
...
```

여기서 `readLines("파일의 경로")`함수는 파일의 내용을 줄 단위로 잘라 vector형태로 값을 반환합니다.

예를 들어, 
```R
# test.text

대충 A라는 내용
대충 B라는 내용
대충 C라는 내용
```
라는 파일을 읽는다면

["대충 A라는 내용", "대충 B라는 내용", "대충 C라는 내용"]의 vector가 만들어집니다.

이를 활용하여 카카오톡 대화방을 긁어와보겠습니다.

### 정규표현식을 사용하여 대화 분리하기

#### 대화 유형 나누기

긁어온 대화 내용을 보면 유형이 5가지로 나누어집니다.

1. --------------- 20XX년 XX월 XX일 X요일 ---------------

2. ~님이 ~을 초대하였습니다.

3. ~님이 나갔습니다.

4. [이름] [오전/오후 XX:XX] 내용

5. 그냥 내용
    - 한 줄씩 긁어오다보니 여러 줄의 내용을 채팅했을 경우, 이렇게 한 줄씩 내용만 긁어와질 때가 있습니다.
    - 이 때는 가장 최근에 메시지를 보낸 사람의 대화내용에 추가하면 됩니다.

#### 정규표현식 구현하기

이제, 정규표현식을 R에서 사용하는 법을 간략하게 알아보겠습니다.

훨씬 많은 함수와 표현식이 있지만 길어질 것 같기에 자세한 내용은 다음 포스팅에 다뤄보겠습니다.

```R
# 1. 
grep(RegExp, vector)
# 벡터 내에 매개변수로 들어간 정규표현식이 포함된 문자열이 있다면 해당 위치를 반환합니다.
# 만약 여러 개가 부합한다면 여러 개의 위치를 반환합니다.
# value=TRUE를 매개변수로 넣는다면 위치가 아닌 해당 문자열을 반환합니다.

# 2.
grepl(RegExp, vector)
# 결과값이 위치가 아니라 TRUE/FALSE값으로 나옵니다.
# ex) True True False True
```

아래는 위 함수를 적용한 코드입니다.

```R
# R > regularExpression.R

# 첫번째 유형, --------------- 20XX년 XX월 XX일 X요일 ---------------
chat_date = grep("-+ 20\\d+년 \\d+월 \\d+일 [가-힣]+요일 -+", data)
# + : 앞 문자가 하나 이상 존재
# \\d : 숫자
# [가-힣] : 모든 한글 문자 중 하나

# 두번째 유형, ~님이 ~을 초대하였습니다.
chat_invite = grep(".+님이 .+님을 초대하였습니다.", data)
# . : 모든 문자 중 하나

# 세번째 유형, ~님이 나갔습니다.
chat_left = grep('.+님이 나갔습니다.', data)


# 네번째 유형, [이름] [오전/오후 XX:XX] 내용
idx_chat = grep("\\[.+\\] \\[오전?후? \\d+:\\d+\\] .+", data)

# 다섯번째 유형, 그냥 내용
# 딱히 가져올 것 없이 위의 네 가지 유형을 제외한 모든 톡
```

대화 내용을 유형에 따라 구분하였으니 필요에 맞게 데이터를 가져와보겠습니다.

이번 목적은 '누가 가장 톡방에서 활발한가?'를 확인하고자 한 것이므로, 시간이나 초대, 나간 사실은 사실 중요하지 않습니다.

다음은 누가, 얼마나 많이, 메시지를 보냈는가를 확인하는 코드입니다.

```R
# R > regularExpression.R

chat_list = list() # 누가 어떤 메시지를 보냈는지 저장하는 리스트를 만들었습니다.
context = '' # 누군가의 메시지를 저장할 공간입니다.
for(i in 4:length(data)){ # 3번째 줄 까지는 대화방의 정보를 나타내므로 생략하였습니다.
    if(i %in% chat_date || i %in% chat_invite || i %in% chat_left) next # 톡한 시간, 초대나 나간 사실은 중요하지 않습니다.
    if(i %in% idx_chat){ # 누가 메시지를 보냈는지 알 수 있습니다.
        temp = strsplit(data[i], '] ')[[1]] # strsplit의 결과값의 형태는 리스트이므로 [[1]]을 사용하여 접근하여야 합니다.
        name = substring(temp[1], 2)
        time = substring(temp[2], 2)
        context = temp[3
        # print(paste(name, time))
    }
    if(context == '') context = data[i] # 5번 유형에도 대응할 수 있게 하였습니다.
    chat_list[name][[1]] = c(chat_list[name][[1]], context) # '사용자'의 대화내용에 추가합니다.
    context = ''
}
```

실제로 결과값인 `chat_list`를 출력해보면

```R
# R > regularExpression.R
print(str(chat_list)) # 리스트의 요약된 정보를 출력합니다.
# List of 11
#  $ : chr [1:252] "." "병역의 의무는" "언제 다하러가는거야..." ...
#  $ : chr [1:222] "ㅎㅇㅎㅇ!" "반가워요 ㅎㅎㅋ" "@----->" "^^" ...
#  $ : chr [1:38] "우와 반가워요" "ㅇㅇ" "입대한지 이틀만에" ...
#  $ : chr [1:340] "와!!!!" "군필 한명 추가인가요" "이모티콘" "이모티콘" ...
#  $ : chr [1:63] "플래다시간다" "하" "안드로이드 c타입키보드" "방향키랑 일부키가안식이안대서" ...
#  $ : chr [1:275] "ㅈㄴ슬퍼" "월급만 기다리고잇엇는데" "노트북 품절됨" "ㄹㅇ;" ...
#  $ : chr [1:35] "그들은 대단한 요리사들이다..ㄷㄷ;" "ㄷㄷ;;;" "너 에픽세븐 한다 그랬었니" ...
#  $ : chr [1:132] "사진" "아 이게 게임이냐고~" "할머니에서 나온 늑대와 벌목기에서나온 할머니에서나온 늑대의 콜라보;" "아 이걸" ...
#  $ : chr [1:202] "나 전에 홀방밀 미러에서 오메가조립시설에서 생성된 무장한 종이박에서 생성된 연합용사 사라아드에서 생성된 용의 보"| __truncated__ "방송이였으면 클립이었다" ...
#  $ : chr [1:102] "디용" "사진" "3성세트" "개꿀잼" ...
#  $ : chr [1:2] "오호" "헋"

print(lapply(chat_list, length))
# $코딩노예 [1] 252
# $uowol  [1] 222
# $A      [1] 38
# $B      [1] 340
# $C      [1] 63
# $D      [1] 275
# $E      [1] 35
# $F      [1] 132
# $G      [1] 202
# $H      [1] 102
# $I      [1] 2
```

B가 상당한 투머치 토커라는 것, I는 개인주의라는 것, 등을 알 수 있었습니다.

~~I야 우리가 더 잘할게!~~

[export]: https://en4u.co.kr/%EC%B9%B4%EC%B9%B4%EC%98%A4%ED%86%A1%EB%82%B4%EB%B3%B4%EB%82%B4%EA%B8%B0/
[before]: posts/post-14